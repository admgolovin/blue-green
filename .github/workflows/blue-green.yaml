name: GitHub Actions Demo
on: push
jobs:
  Explore-GitHub-Actions:
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    runs-on: [self-hosted, Linux, X64]
    steps:
    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v2
    
    # Get the list of changed files
    - uses: jitterbit/get-changed-files@v1
      with:
        # Format of the steps output context.
        # Can be 'space-delimited', 'csv', or 'json'.
        # Default: 'space-delimited'
        format: 'space-delimited'
  
    - name: Print changed files
      run: |
        for changed_file in ${{ steps.files.outputs.all }}; do
          echo "Do something with this ${changed_file}."
        done
    
    # Install the latest version of Terraform CLI and configure the Terraform CLI configuration file with a Terraform Cloud user API token
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1

    - name: Verify Terraform version
      run: terraform --version

    - name: Terraform init
      working-directory: ./terraform
      run: terraform init -input=false
    
    - name: Terraform Plan
      working-directory: ./terraform
      run: terraform plan

    - name: Terraform validation
      working-directory: ./terraform
      run: terraform validate

    - name: Terraform apply
      working-directory: ./terraform
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      run: terraform apply -auto-approve -input=false
